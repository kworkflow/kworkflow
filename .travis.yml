language: bash
os: linux
dist: focal

# Prepare for dependencies installation
before_install:
  - sudo apt-get -y update

# Install dependencies
install:
  - >
    sudo apt-get -y install libguestfs-tools qemu bash git
    python-docutils dash shunit2 graphviz python3-sphinx kcov

# Prepare to execute tests
before_script:
  - ./run_tests.sh prepare
  - mkdir kcov_out/

# Execute tests, calculate coverage, docs build and kw installation to check for errors
script:
  - ./run_tests.sh
  - ./setup.sh --docs --force
  - ./setup.sh -i --force
  - kcov --include-path=src,kw --exclude-pattern=src/bash_autocomplete.sh,src/help.sh kcov_out/ ./run_tests.sh

# Upload code coverage generated by kcov
after_success:
  - bash <(curl -s https://codecov.io/bash) -s kcov_out/

notifications:
  email:
    on_success: never
    on_failure: always
